<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Video Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #fff; }
    video { width: 45%; margin: 5px; background: black; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
  </style>
</head>
<body>

<h2>تماس تصویری دوطرفه</h2>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<br>
<button onclick="startCall()">شروع تماس</button>
<button onclick="joinCall()">پیوستن</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    databaseURL: "https://video-call-2ecce-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");

  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      localVideo.srcObject = stream;
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
    });

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  pc.onicecandidate = e => {
    if (e.candidate) {
      db.ref("candidates").push(JSON.stringify(e.candidate));
    }
  };

  db.ref("candidates").on("child_added", snap => {
    pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
  });

  async function startCall() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    db.ref("offer").set(JSON.stringify(offer));
  }

  async function joinCall() {
    db.ref("offer").once("value", async snap => {
      const offer = JSON.parse(snap.val());
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      db.ref("answer").set(JSON.stringify(answer));
    });
  }

  db.ref("answer").on("value", async snap => {
    if (snap.val()) {
      const answer = JSON.parse(snap.val());
      await pc.setRemoteDescription(answer);
    }
  });
</script>

</body>
</html>
